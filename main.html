<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="css/font-awesome.min.css" />
    <link rel="stylesheet" href="css/global.css" />
    <link rel="stylesheet" href="css/index.css" />
    <style>
      .test {
        width: 100px;
        height: 300px;
        background: goldenrod;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <div class="navbar">
        <div class="logo">
          <span class="logo-txt">后台管理系统</span>
          <span class="logo-brand">
            WSS
          </span>
        </div>
        <ul class="menu">
          <!-- <li class="level1">
            <a href="index.html" class="menu-item">
              <i class="fa fa-gear"></i>
              <span class="nav-label">首页</span>
            </a>
          </li>
          <li class="level1">
            <a href="#">
              <i class="fa fa-video-camera"></i>
              <span class="nav-label">系统管理</span>
              <span class="arrow arrow-left"></span>
            </a>
            <ul class="level2">
              <li>
                <a href="system/user.html" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">用户管理</span>
                </a>
              </li>
              <li>
                <a href="system/role.html" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">角色管理</span>
                </a>
              </li>
              <li>
                <a href="system/dept.html" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">部门管理</span>
                </a>
              </li>
            </ul>
          </li>
          <li class="level1">
            <a href="#">
              <i class="fa fa-video-camera"></i>
              <span class="nav-label">系统监控</span>
              <span class="arrow arrow-left"></span>
            </a>
            <ul class="level2">
              <li>
                <a href="system/online.html" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">在线用户</span>
                </a>
              </li>
              <li>
                <a href="system/job.html" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">定时任务</span>
                </a>
              </li>
              <li>
                <a href="system/monitor.html" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">数据监控</span>
                </a>
              </li>
            </ul>
          </li>
          <li class="level1">
            <a href="#">
              <i class="fa fa-video-camera"></i>
              <span class="nav-label">系统工具</span>
              <span class="arrow arrow-left"></span>
            </a>
            <ul class="level2">
              <li>
                <a href="#" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">表单构建</span>
                </a>
              </li>
              <li>
                <a href="#" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">代码生成</span>
                </a>
              </li>
              <li>
                <a href="#" class="menu-item">
                  <i class="fa fa-address-card"></i>
                  <span class="nav-label">系统接口</span>
                </a>
              </li>
            </ul>
          </li> -->

          <script id="menu-template" type="text/html">
            {{ each $data }}
              <!-- 有二级菜单的 -->
              {{ if $value.children }}
              <li class="level1" class="level1">
                <a href="#">
                  <i class="{{ $value.icon }}"></i>
                  <span class="nav-label">{{ $value.name }}</span>
                  <span class="arrow arrow-left"></span>
                </a>
                <ul class="level2">
                  {{ each $value.children as item i }}
                    <a href="{{ item.url }}" class="menu-item">
                      <i class="{{ item.icon }}"></i>
                      <span class="nav-label">{{ item.name }}</span>
                    </a>
                  {{ /each }}
                </ul>
              </li>
              {{ else }}
              <!-- 没有二级菜单的 -->
              <li class="level1">
                <a href="{{ $value.url }}" class="menu-item">
                  <i class="{{ $value.icon }}"></i>
                  <span class="nav-label">{{ $value.name }}</span>
                </a>
              </li>
            {{ /if }}
            {{ /each }}
          </script>
        </ul>
      </div>
      <div class="page-wrapper">
        <div class="header">
          <div class="fold-btn">
            <ul>
              <li></li>
              <li></li>
              <li></li>
            </ul>
          </div>
          <ul class="message">
            <li class="user-info">
              <a href="#">
                <img src="images/profile.jpg" class="user-image" alt="" />
                <span class="user-name">admin</span>
              </a>
              <ul class="second">
                <li>个人中心</li>
                <li>修改密码</li>
                <li>退出</li>
              </ul>
            </li>
          </ul>
        </div>
        <div class="content-tabs">
          <!-- 左移按钮 -->
          <button class="roll-btn tab-left">
            <i class="fa fa-backward"></i>
          </button>
          <div class="menu-tab-content">
            <div class="tabs-inner">
              <a
                href="javascript:;"
                class="active menu-tab"
                data-id="index.html"
                >首页</a
              >
            </div>
          </div>
          <!-- 右移按钮 -->
          <button class="roll-btn tab-right">
            <i class="fa fa-forward"></i>
          </button>
          <div class="tag-ctrl">
            <span>页签操作</span>
            <ul class="dropdown-menu">
              <li>
                <a class="tab-close-current" href="javascript:;">关闭当前</a>
              </li>
              <li>
                <a class="tab-close-other" href="javascript:;">关闭其他</a>
              </li>
              <li><a class="tab-close-all" href="javascript:;">全部关闭</a></li>
            </ul>
          </div>
        </div>
        <div class="main-content">
          <iframe
            class="iframe"
            name="iframe0"
            width="100%"
            height="100%"
            data-id="index.html"
            src="index.html"
            frameborder="0"
            seamless
          ></iframe>
        </div>
        <div class="footer">© 2020 wss Copyright</div>
      </div>
    </div>
    <script src="js/jquery.js"></script>
    <script src="js/template-web.js"></script>
    <script>
      /**
       *  注意:
       *  1. 所有的目录a标签不会有menu-item的class类名
       *  2. 所有的菜单a标签是需要menu-item的calss类名
       *  3. 点击菜单时用toggleClass
       *  3. 点击菜单时用slideToggle
       *  4. 左侧菜单需要添加href属性(链接地址)
       *  5. tab菜单切换需要data-id,它的值取的是左侧菜单的href的值
       *  6. $().each是通过return false跳出循环
       * **/

      /**
        tab切换的地方
        1.点击左侧菜单,menu-item进行切换,menu-tab进行切换, iframe进行切换
        2.点击menu-tab,menu-tab进行切换,iframe进行切换
        3.点击关闭tab, menu-tab进行切换,iframe进行切换 
        4.需要有data-id值,该值来自于左边菜单的href值
      **/

      /**
        iframe标签
        1. name属性的值来自左边菜单的data-index的值
        2. 需要给每个iframe添加class="iframe",因为后面都是通过该类名来获取iframe元素的
        3. 需要有data-id值,该值来自于左边菜单的href值,tab选项卡的值的也是来自左边菜单的href值      
      **/

      /**
        关联关系:
        menu-item的href - menu-tab的data-id  iframe的data-id 
      **/

      /**
        tab选项卡dom层级结构
        --0.content-tabs
          --1.tab-left  // 查看左侧隐藏的tab选项卡
          --1.menu-tab-content // 存放tab选项卡的地方
            --2.tabs-inner // 实际上滚动的是该元素(无缝滚动原理一样)
              3.--menu-tab // 每一个tab选项卡
          --1.tab-right  // 查看右侧隐藏的tab选项卡
      **/

      $(function () {
        $.ajax({
          url: './data/menu.json',
          type: 'get',
          success: function (res) {
            let html = template('menu-template', res)
            $('.menu').html(html)
          }
        })
      })
      // 1.菜单的折叠和展开
      $('.fold-btn').toggle(
        function () {
          $('.wrapper').addClass('fold')
        },
        function () {
          $('.wrapper').removeClass('fold')
        }
      )

      // 2.左侧菜单
      // 注意这个地方选中的是.level1 > a
      // 不能直接选中 .level1 ,否则点击.level的子项菜单也就折叠
      $('.navbar .menu').on('click', '.level1 > a', function () {
        // 1.当前菜单高亮，其他不高亮
        // $(this).parent().addClass('active').siblings().removeClass('active')

        // tips: 002-这里将addClass换成toggleClass
        $(this).parent().toggleClass('active').siblings().removeClass('active')

        // 2.点击当前菜单的二级菜单展开或者折叠
        $(this).next().slideToggle()

        // 3.其他的菜单的二级菜单折叠(也就是只会保留一个二级菜单时展开的)
        $(this).parent().siblings().find('.level2').slideUp()
      })

      // 3.通过遍历给菜单向添加data-index

      $('.menu-item').each(function (index, value) {
        if (!$(this).attr('data-index')) {
          $(this).attr('data-index', index)
        }
      })

      // 4.创建tab选项卡
      function creataTab() {
        let flag = true // true: 需要创建 false: 不需要创建(之前已经创建好了)
        let tabName = $.trim($(this).text()) // 获取点击的菜单名称
        let href = $(this).attr('href') // 获取地址
        let index = $(this).data('index') // 获取data-index值

        if (!href) return // 如果不存在链接地址，直接返回

        // 1.需要判断tab是否已经存在，如果存在了就不需要创建了
        $('.menu-tab').each(function () {
          if ($(this).data('id') === href) {
            // 当前tab选项卡高亮
            $(this).addClass('active').siblings().removeClass('active')
            scrollToTab(this)
            flag = false
            return false // 跳出循环
          }
        })
        // 当前对应的iframe高亮
        $('.main-content iframe.iframe').each(function () {
          if ($(this).data('id') === href) {
            $(this).show().siblings().hide()
            return false
          }
        })

        // 2.需要创建tab
        if (flag) {
          // 添加tab选项卡
          let str = `<a href="javascript:;" class="active menu-tab" data-id="${href}">${tabName}<i class="fa fa-times-circle"></i></a>`
          // 移除其他tab选项卡的active样式
          $('.menu-tab').removeClass('active')
          $('.content-tabs .menu-tab-content .tabs-inner').append(str)
          // 添加选项卡对应的iframe
          let str1 = `<iframe class="iframe" name="iframe${index}" width="100%" height="100%" frameborder="0" src="${href}" data-id="${href}" seamless></iframe>`
          $('.main-content').find('iframe.iframe').hide()
          $('.main-content').append(str1)
          scrollToTab($('.menu-tab.active'))
        }

        // 3.防止a链接跳转
        return false
      }

      // 5.给左侧菜单向添加单击事件
      // 动态添加的元素需要事件委托来绑定事件处理函数
      $('.menu').on('click', '.menu-item', creataTab)

      // 6.点击tab选项卡
      function activeTab() {
        if (!$(this).hasClass('active')) {
          let currentId = $(this).data('id')
          // 当前高亮
          $(this).addClass('active').siblings().removeClass('active')
          // 当前对应的iframe高亮
          $('.main-content iframe.iframe').each(function () {
            if ($(this).data('id') === currentId) {
              $(this).show().siblings().hide()
              return false
            }
          })
          scrollToTab(this)
        }
      }

      $('.content-tabs .menu-tab-content .tabs-inner').on(
        'click',
        '.menu-tab',
        activeTab
      )

      // 7.关闭选项卡
      function closeTab() {
        let closeTabId = $(this).parent().data('id')
        // 如果当前元素处在激活状态
        if ($(this).parent().hasClass('active')) {
          // 如果当前元素后面有同辈元素
          if ($(this).parent().next().size()) {
            let activeId = $(this).parent().next().data('id')
            $(this).parent().next().addClass('active')
            $('.main-content iframe.iframe').each(function () {
              if ($(this).data('id') === activeId) {
                $(this).show().siblings().hide()
                return false
              }
            })

            // 移除当前tab选项卡
            $(this).parent().get(0).remove() // 使用的是原生的remove方法进行删除
            // 移除对应的iframe
            $('.main-content iframe.iframe').each(function () {
              if ($(this).data('id') === closeTabId) {
                $(this).remove()
                return false
              }
            })
          } else {
            // 如果当前元素的后面没有同辈元素
            let activeId = $(this).parent().prev().data('id')
            $(this).parent().prev().addClass('active')
            $('.main-content iframe.iframe').each(function () {
              if ($(this).data('id') === activeId) {
                $(this).show().siblings().hide()
                return false
              }
            })

            // 移出当前选项卡
            $(this).parent().get(0).remove() // 使用的是原生的remove方法进行删除
            // 移除对应的iframe
            $('.main-content iframe.iframe').each(function () {
              if ($(this).data('id') === closeTabId) {
                $(this).remove()
                return false
              }
            })
          }
        } else {
          // 如果当前元素不存在激活状态下
          $(this).parent().get(0).remove()
          // 移除对应的iframe
          $('.main-content iframe.iframe').each(function () {
            if ($(this).data('id') === closeTabId) {
              $(this).remove()
              return false
            }
          })
        }
      }

      $('.content-tabs .menu-tab-content .tabs-inner').on(
        'click',
        '.menu-tab i',
        closeTab
      )

      // 8.页签操作

      // 8.1 关闭当前的tab标签
      $('.tab-close-current').on('click', function () {
        $('.menu-tab.active>i').click()
      })

      // 8.2 关闭其他的tab标签
      $('.tab-close-other').on('click', function () {
        // 去掉默认的和当前的
        $('.menu-tab')
          .not('.active')
          .not(':first')
          .each(function () {
            $(this).find('i').click()
          })
      })

      // 8.3 全部关闭
      $('.tab-close-all').on('click', function () {
        // 去掉默认的
        $('.menu-tab')
          .not(':first')
          .each(function () {
            $(this).find('i').click()
          })
      })

      // 9.
      function scrollToTab(element) {
        let marginLeftVal = calSumWidth($(element).prevAll())
        let marginRightVal = calSumWidth($(element).nextAll())
        let eles = $('.content-tabs').children().not('.menu-tab-content')
        // 获取非tab选项卡其他元素的总宽度
        let tabOuterWidth = calSumWidth(eles)
        // tab选项卡显示的区域的
        let visibleWidth = $('.content-tabs').outerWidth(true) - tabOuterWidth

        let scrollVal = 0
        // 实际需要滚动的距离
        if ($('.tabs-inner').outerWidth() < visibleWidth) {
          scrollVal = 0
        } else if (
          marginRightVal <=
          visibleWidth -
            $(element).outerWidth(true) -
            $(element).next().outerWidth(true)
        ) {
          if (
            visibleWidth - $(element).next().outerWidth(true) >
            marginRightVal
          ) {
            scrollVal = marginLeftVal
            var tabElement = element
            while (
              scrollVal - $(tabElement).outerWidth() >
              $('.tabs-inner').outerWidth() - visibleWidth
            ) {
              scrollVal -= $(tabElement).prev().outerWidth()
              tabElement = $(tabElement).prev()
            }
          }
        } else if (
          marginLeftVal >
          visibleWidth -
            $(element).outerWidth(true) -
            $(element).prev().outerWidth(true)
        ) {
          scrollVal = marginLeftVal - $(element).prev().outerWidth(true)
        }
        $('.tabs-inner').animate(
          {
            marginLeft: 0 - scrollVal + 'px'
          },
          'fast'
        )
      }

      // 计算元素集合的总宽度
      function calSumWidth(elements) {
        let width = 0
        $(elements).each(function () {
          width += $(this).outerWidth(true) // 包含margin的宽度
        })
        return width
      }

      // 查看左侧隐藏的tab选项卡
      function scrollTabLeft() {
        let marginLeftVal = Math.abs(
          parseInt($('.tabs-inner').css('margin-left')) + 50
        )
        // 可视区域非tab宽度
        let tabOuterWidth = calSumWidth(
          $('.content-tabs').children().not('.menu-tab-content')
        )
        //可视区域tab宽度
        let visibleWidth = $('.content-tabs').outerWidth(true) - tabOuterWidth
        //实际滚动宽度
        let scrollVal = 0
        if ($('.tabs-inner').width() < visibleWidth) {
          return false
        } else {
          let tabElement = $('.menu-tab:first')
          let offsetVal = 0
          while (offsetVal + $(tabElement).outerWidth(true) <= marginLeftVal) {
            //找到离当前tab最近的元素
            offsetVal += $(tabElement).outerWidth(true)
            tabElement = $(tabElement).next()
          }
          offsetVal = 0
          if (calSumWidth($(tabElement).prevAll()) > visibleWidth) {
            while (
              offsetVal + $(tabElement).outerWidth(true) < visibleWidth &&
              tabElement.length > 0
            ) {
              offsetVal += $(tabElement).outerWidth(true)
              tabElement = $(tabElement).prev()
            }
            scrollVal = calSumWidth($(tabElement).prevAll())
          }
        }
        $('.tabs-inner').animate(
          {
            marginLeft: 0 - scrollVal + 'px'
          },
          'fast'
        )
      }

      // 查看右侧隐藏的选项卡
      function scrollTabRight() {
        let marginLeftVal = Math.abs(
          parseInt($('.tabs-inner').css('margin-left'))
        )
        // 可视区域非tab宽度
        let tabOuterWidth = calSumWidth(
          $('.content-tabs').children().not('.menu-tab-content')
        )
        //可视区域tab宽度
        let visibleWidth = $('.content-tabs').outerWidth(true) - tabOuterWidth
        //实际滚动宽度
        let scrollVal = 0
        if ($('.tabs-inner').width() < visibleWidth) {
          return false
        } else {
          let tabElement = $('.menu-tab:first')
          let offsetVal = 0
          while (offsetVal + $(tabElement).outerWidth(true) <= marginLeftVal) {
            //找到离当前tab最近的元素
            offsetVal += $(tabElement).outerWidth(true)
            tabElement = $(tabElement).next()
          }
          offsetVal = 0
          while (
            offsetVal + $(tabElement).outerWidth(true) < visibleWidth &&
            tabElement.length > 0
          ) {
            offsetVal += $(tabElement).outerWidth(true)
            tabElement = $(tabElement).next()
          }
          scrollVal = calSumWidth($(tabElement).prevAll())
          if (scrollVal > 0) {
            $('.tabs-inner').animate(
              {
                marginLeft: 0 - scrollVal + 'px'
              },
              'fast'
            )
          }
        }
      }
      $('.tab-left').on('click', scrollTabLeft)
      $('.tab-right').on('click', scrollTabRight)
    </script>
  </body>
</html>
